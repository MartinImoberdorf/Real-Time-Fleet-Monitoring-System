<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real-Time Vehicle Telemetry</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: {
              bg: '#0f172a',
              surface: '#1e293b',
              border: '#334155',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen">

<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-center mb-2 text-white">
      Real-Time Vehicle Telemetry
    </h1>
    <div class="flex items-center justify-center gap-2 mt-4">
      <div id="status" class="px-4 py-2 rounded-lg font-semibold bg-slate-800 border border-slate-700">
        Connecting to WebSocket...
      </div>
    </div>
  </div>

  <!-- Tables Container - Side by Side -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Normal Data Table -->
    <div class="bg-slate-800 rounded-xl shadow-2xl border border-slate-700 overflow-hidden">
      <div class="bg-slate-900 px-6 py-4 border-b border-slate-700">
        <h2 class="text-xl font-bold text-green-400">Normal Data</h2>
        <p class="text-sm text-gray-400 mt-1" id="normal-count">0 registros</p>
      </div>
      <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
        <table class="w-full">
          <thead class="bg-slate-900 border-b border-slate-700 sticky top-0">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Vehicle</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Speed</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Acceleration</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Battery</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Temp</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Traffic</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Type</th>
            </tr>
          </thead>
          <tbody id="telemetry-body" class="divide-y divide-slate-700">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Anomalies Table -->
    <div class="bg-slate-800 rounded-xl shadow-2xl border border-red-700 overflow-hidden">
      <div class="bg-red-900/30 px-6 py-4 border-b border-red-700">
        <h2 class="text-xl font-bold text-red-400">Anomalies</h2>
        <p class="text-sm text-gray-400 mt-1" id="anomaly-count">0 registros</p>
      </div>
      <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
        <table class="w-full">
          <thead class="bg-slate-900 border-b border-slate-700 sticky top-0">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Vehicle</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Speed</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Acceleration</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Battery</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Temp</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Traffic</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Type</th>
            </tr>
          </thead>
          <tbody id="anomaly-body" class="divide-y divide-slate-700">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  const wsUrl = "ws://localhost:8082/ws/telemetry";
  const statusEl = document.getElementById("status");
  const tableBody = document.getElementById("telemetry-body");
  const anomalyBody = document.getElementById("anomaly-body");
  const normalCountEl = document.getElementById("normal-count");
  const anomalyCountEl = document.getElementById("anomaly-count");
  const maxRows = 20;
  let messageCount = 0;
  let ws = null;
  let reconnectInterval = 5000; // Tiempo entre intentos de reconexión (5 segundos)

  // Helper function to safely format values
  function formatValue(value, isNumber = false, decimals = 1, suffix = '') {
    if (value === null || value === undefined) return '-';
    if (isNumber && typeof value === 'number') {
      return value.toFixed(decimals) + suffix;
    }
    return String(value);
  }

  // Helper function to update status with Tailwind classes
  function updateStatus(message, type = 'info') {
    statusEl.textContent = message;
    statusEl.className = 'px-4 py-2 rounded-lg font-semibold border transition-colors duration-300 ';
    switch(type) {
      case 'connected':
        statusEl.className += 'bg-green-900/30 border-green-700 text-green-400';
        break;
      case 'disconnected':
        statusEl.className += 'bg-red-900/30 border-red-700 text-red-400';
        break;
      case 'warning':
        statusEl.className += 'bg-yellow-900/30 border-yellow-700 text-yellow-400';
        break;
      case 'error':
        statusEl.className += 'bg-orange-900/30 border-orange-700 text-orange-400';
        break;
      default:
        statusEl.className += 'bg-slate-800 border-slate-700 text-gray-300';
    }
  }

  function connectWebSocket() {
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      console.log("✅ WebSocket reconectado");
      updateStatus("Reconectado al WebSocket", 'connected');
      
      // Check after 5 seconds if we're receiving messages
      setTimeout(() => {
        if (messageCount === 0) {
          console.warn("⚠️ No messages received after 5 seconds");
          updateStatus("Conectado pero sin datos aún. Verificando servidor...", 'warning');
        }
      }, 5000);
    };

    ws.onclose = () => {
      console.warn("❌ WebSocket desconectado. Intentando reconectar...");
      updateStatus("Desconectado. Intentando reconectar...", 'disconnected');
      setTimeout(connectWebSocket, reconnectInterval);
    };

    ws.onerror = (error) => {
      console.error("⚠️ Error en WebSocket:", error);
      updateStatus("⚠️ Error en WebSocket. Ver consola.", 'error');
    };

    ws.onmessage = (event) => {
      messageCount++;
      console.log(`Message #${messageCount} received:`, event.data);
      
      try {
        const data = JSON.parse(event.data);
        console.log("✅ Parsed JSON data:", data);
        
        // Normalize field names (handle both camelCase and snake_case)
        // Always show data, even if null/undefined
        const vehicleId = data.vehicleId ?? data.vehicle_id ?? data.id ?? data.vehicle ?? '-';
        const speed = data.speed ?? data.speed_kmh ?? data.speed_km ?? null;
        const acceleration = data.acceleration ?? data.accel ?? null;
        const battery = data.battery ?? data.battery_level ?? data.batteryLevel ?? null;
        const temperature = data.temperature ?? data.temp ?? data.temp_c ?? data.tempC ?? null;
        const trafficLevel = data.trafficLevel ?? data.traffic_level ?? data.traffic ?? null;
        const anomaly = data.anomaly ?? false;
        const anomalyType = data.anomalyType ?? data.anomaly_type ?? null;

        const row = document.createElement("tr");
        const targetBody = anomaly ? anomalyBody : tableBody;
        
        // Apply Tailwind classes based on anomaly status
        if (anomaly) {
          row.className = "bg-red-900/20 hover:bg-red-900/30 border-l-4 border-red-500 transition-colors";
        } else {
          row.className = "bg-slate-800/50 hover:bg-slate-700/50 border-l-4 border-green-500 transition-colors";
        }

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-200">${formatValue(vehicleId)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-400">${formatValue(speed, true, 1)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-400">${formatValue(acceleration, true, 2)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-400">${formatValue(battery, true, 1, '%')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-400">${formatValue(temperature, true, 1, '°C')}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-cyan-400">${formatValue(trafficLevel)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatValue(anomalyType)}</td>
        `;

        // Add the new row at the top of the appropriate table
        targetBody.prepend(row);
        console.log(`✅ Row added to ${anomaly ? 'anomaly' : 'normal'} table. Total rows:`, targetBody.rows.length);

        // Limit the number of rows in each table
        if (targetBody.rows.length > maxRows) {
          targetBody.deleteRow(targetBody.rows.length - 1);
        }
        
        // Update counters
        normalCountEl.textContent = `${tableBody.rows.length} registro(s)`;
        anomalyCountEl.textContent = `${anomalyBody.rows.length} registro(s)`;
        
        // Update status to show we're receiving data
        const totalRows = tableBody.rows.length + anomalyBody.rows.length;
        updateStatus(`Conectado - ${totalRows} fila(s) recibida(s)`, 'connected');
      } catch (err) {
        console.error("Error processing WebSocket message:", err);
        console.error("Raw message:", event.data);
        // Even if JSON parsing fails, try to show the raw data in the normal table
        const row = document.createElement("tr");
        row.className = "bg-orange-900/20 border-l-4 border-orange-500";
        row.innerHTML = `
          <td colspan="7" class="px-6 py-4 text-sm text-orange-400">
            ⚠️ Error parsing: ${String(event.data).substring(0, 100)}
          </td>
        `;
        tableBody.prepend(row);
        normalCountEl.textContent = `${tableBody.rows.length} registro(s)`;
        updateStatus(`Error procesando mensaje: ${err.message}`, 'error');
      }
    };
  }

  // Llamar a la función de conexión inicial
  connectWebSocket();
</script>

</body>
</html>